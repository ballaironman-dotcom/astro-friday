---
import PostHead from '~/components/PostHead.astro'
import DefaultLayout from '~/layouts/Default.astro'
import PostTOC from '~/components/PostTOC.astro'

let data
let render
let headings
let Content

if (Astro.props.frontmatter) { // used in md
  ;({ frontmatter: data, headings } = Astro.props)
}
else {
  ;({ data, render } = Astro.props)

  ;({ Content, headings } = await render())
}
---

<DefaultLayout>
  <PostHead slot="head" {...data} />

  <div
    class:list={[
      'relative',
      'flex flex-row',
      'layout_post',
    ]}
  >
    <article class:list={[
      'markdown', // unocss typography
      'mx-auto !max-w-[clamp(70%,90%,65ch)] w-[clamp(70%,90%,65ch)]',
      'lg:(px-8)',
    ]}>
      <slot>
        {Content ? <Content /> : null}
      </slot>
    </article>

    <aside class:list={[
      'flex-1',
      'overflow-auto overscroll-contain p-4 bg-primary',
      'lt-lg:(fixed z-100 left-4 right-4 top-4 h-60lvh m-auto translate-x--100vw transition-all site-shadow-60 rounded-lg)',
      'lg:(sticky top-0 h-100dvh max-h-100dvh  text-text:70)',
      'layout_post__toc',
    ]}>
      <PostTOC
        range={[2, 4]}
        number={true}
        line={true}
        key="post-aside"
        headings={headings.map(heading => ({ ...heading, title: heading.text, url: `#${heading.slug}` }))}
      />
    </aside>

  </div>
</DefaultLayout>

<script>
  const toc = document.querySelector('.layout_post__toc')
  toc?.addEventListener('click', (event) => {
    if (window.innerWidth < 1024 || event.target?.tagName === 'A') {
      toc.classList.remove('!translate-none')
    }

    if (
      event.target
      && event.target instanceof HTMLAnchorElement
      && event.target.hash.startsWith('#')
    ) {
      event.preventDefault()
      // do something
      try {
        // 解码这一步会有失败的可能, 这里使用 try catch 进行捕获
        const hash = decodeURIComponent(event.target.hash)
        const target = document.querySelector(hash)
        window.scrollTo({
          top: target?.offsetTop - 20,
          behavior: 'smooth',
        })
        history.pushState(null, '', event.target.hash)
      }
      catch (error) {
        console.error(error)
      }
    }
  })
</script>
